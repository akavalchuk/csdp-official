apiVersion: batch/v1
kind: Job
metadata:
  name: csdp-installer
  labels:
    {{- include "csdp-installer.labels" . | nindent 4 }}
spec:
  ttlSecondsAfterFinished: {{ .Values.csdp.installer.ttlSecondsAfterFinished }}
  backoffLimit: {{ .Values.csdp.installer.backoffLimit }}
  template:
    metadata:
      labels:
        {{- include "csdp-installer.selectorLabels" . | nindent 8 }}
    spec:
      serviceAccount: {{ .Values.csdp.installer.serviceAccount }}
      restartPolicy: Never
      containers:
        - name: csdp-installer
          image: "{{ .Values.csdp.installer.image.repository }}:{{ .Values.csdp.installer.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.csdp.installer.imagePullPolicy }}
          command:
            - bash
          args:
            - ./install.sh
          env:
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: CSDP_URL
              valueFrom:
                configMapKeyRef:
                  name: "{{ include "csdp-installer.fullname" . }}-cm"
                  key: csdp.url
            - name: CSDP_TOKEN
              valueFrom:
                configMapKeyRef:
                  name: "{{ include "csdp-installer.fullname" . }}-cm"
                  key: csdp.token
            - name: CSDP_RUNTIME_NAME
              valueFrom:
                configMapKeyRef:
                  name: "{{ include "csdp-installer.fullname" . }}-cm"
                  key: runtime.name
            - name: CSDP_RUNTIME_VERSION
              valueFrom:
                configMapKeyRef:
                  name: "{{ include "csdp-installer.fullname" . }}-cm"
                  key: runtime.version
                  optional: true
            - name: CSDP_RUNTIME_REPO
              valueFrom:
                configMapKeyRef:
                  name: "{{ include "csdp-installer.fullname" . }}-cm"
                  key: runtime.repo
            - name: CSDP_RUNTIME_GIT_TOKEN
              valueFrom:
                configMapKeyRef:
                  name: "{{ include "csdp-installer.fullname" . }}-cm"
                  key: runtime.gitToken
            - name: CSDP_RUNTIME_CLUSTER
              valueFrom:
                configMapKeyRef:
                  name: "{{ include "csdp-installer.fullname" . }}-cm"
                  key: runtime.cluster
            - name: CSDP_RUNTIME_INGRESS_URL
              valueFrom:
                configMapKeyRef:
                  name: "{{ include "csdp-installer.fullname" . }}-cm"
                  key: runtime.ingressURL
            - name: CSDP_GIT_INTEGRATION_PROVIDER
              valueFrom:
                configMapKeyRef:
                  name: "{{ include "csdp-installer.fullname" . }}-cm"
                  key: gitIntegration.provider
                  optional: true
            - name: CSDP_GIT_INTEGRATION_API_URL
              valueFrom:
                configMapKeyRef:
                  name: "{{ include "csdp-installer.fullname" . }}-cm"
                  key: gitIntegration.apiURL
                  optional: true
            - name: CSDP_GIT_INTEGRATION_TOKEN
              valueFrom:
                configMapKeyRef:
                  name: "{{ include "csdp-installer.fullname" . }}-cm"
                  key: gitIntegration.token
                  optional: true
          resources:
            {{- toYaml .Values.csdp.installer.resources | nindent 12 }}
